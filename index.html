<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spiritual Course Management - Journey to Enlightenment</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
            letter-spacing: 2px;
        }

        .header .subtitle {
            font-style: italic;
            opacity: 0.9;
            font-size: 1.2em;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }

        .auth-section {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .auth-card {
            flex: 1;
            min-width: 300px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #764ba2;
            font-weight: bold;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s;
            font-family: inherit;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none !important;
        }

        .course-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .course-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
            position: relative;
        }

        .course-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }

        .course-title {
            font-size: 1.5em;
            color: #764ba2;
            margin-bottom: 10px;
        }

        .course-description {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .course-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .user-info {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            color: white;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal-content {
            background: white;
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 20px;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            cursor: pointer;
            color: #999;
        }

        .close-modal:hover {
            color: #333;
        }

        .student-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .student-item,
        .enrollment-item {
            padding: 15px;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 1em;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #764ba2;
            border-bottom-color: #764ba2;
            font-weight: bold;
        }

        .tab:hover {
            color: #667eea;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        .lotus-divider {
            text-align: center;
            margin: 30px 0;
            color: white;
            font-size: 2em;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üïâÔ∏è Spiritual Course Management</h1>
            <div class="subtitle">Journey to Enlightenment Through Learning</div>
        </div>

        <!-- User Info (Hidden by default) -->
        <div id="userInfo" class="user-info hidden">
            <div>
                <strong id="userDisplay"></strong>
                <span id="userRole"></span>
            </div>
            <button class="btn btn-secondary" onclick="logout()">Logout</button>
        </div>

        <!-- Global Message -->
        <div id="globalMessage" class="message"></div>

        <!-- Authentication Section (Visible by default) -->
        <div id="authSection" class="card">
            <div class="tabs">
                <button class="tab active" onclick="showAuthTab('student')">Student Portal</button>
                <button class="tab" onclick="showAuthTab('admin')">Admin Portal</button>
            </div>

            <!-- Student Auth -->
            <div id="studentAuthTab" class="auth-section">
                <div class="auth-card">
                    <h2 style="color: #764ba2; margin-bottom: 20px;">Student Login</h2>
                    <form id="studentLoginForm">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="studentLoginEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="studentLoginPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Login</button>
                    </form>
                </div>

                <div class="auth-card">
                    <h2 style="color: #764ba2; margin-bottom: 20px;">Student Signup</h2>
                    <form id="studentSignupForm">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="studentSignupName">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="studentSignupEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="studentSignupPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Sign Up</button>
                    </form>
                </div>
            </div>

            <!-- Admin Auth -->
            <div id="adminAuthTab" class="auth-section hidden">
                <div class="auth-card">
                    <h2 style="color: #764ba2; margin-bottom: 20px;">Admin Login</h2>
                    <p style="margin-bottom: 15px; color: #666;">
                        <em>Default credentials: admin / admin123</em>
                    </p>
                    <form id="adminLoginForm">
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="adminLoginUsername" required>
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="adminLoginPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Login</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="lotus-divider">‚ò∏Ô∏è</div>

        <!-- Student Dashboard (Hidden by default) -->
        <div id="studentDashboard" class="card hidden">
            <h2 style="color: #764ba2; margin-bottom: 20px;">My Spiritual Courses</h2>
            <div id="studentCourses" class="course-grid"></div>
        </div>

        <!-- Admin Dashboard (Hidden by default) -->
        <div id="adminDashboard" class="card hidden">
            <div class="tabs">
                <button class="tab active" onclick="showAdminTab('courses')">Manage Courses</button>
                <button class="tab" onclick="showAdminTab('students')">Manage Students</button>
            </div>

            <!-- Courses Tab -->
            <div id="adminCoursesTab">
                <button class="btn btn-success" onclick="showCourseModal()">Create New Course</button>
                <div id="adminCourses" class="course-grid"></div>
            </div>

            <!-- Students Tab -->
            <div id="adminStudentsTab" class="hidden">
                <div id="adminStudents" class="student-list"></div>
            </div>
        </div>

        <!-- Course Modal -->
        <div id="courseModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeCourseModal()">&times;</span>
                <h2 id="courseModalTitle" style="color: #764ba2; margin-bottom: 20px;">Create Course</h2>
                <form id="courseForm">
                    <input type="hidden" id="courseId">
                    <div class="form-group">
                        <label>Course Title</label>
                        <input type="text" id="courseTitle" required>
                    </div>
                    <div class="form-group">
                        <label>Course Description</label>
                        <textarea id="courseDescription" rows="5" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Course</button>
                </form>
            </div>
        </div>

        <!-- Enrollment Modal -->
        <div id="enrollmentModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeEnrollmentModal()">&times;</span>
                <h2 style="color: #764ba2; margin-bottom: 20px;">Manage Enrollments</h2>
                <h3 id="enrollmentCourseTitle" style="margin-bottom: 20px;"></h3>

                <div style="margin-bottom: 20px;">
                    <label>Select Student to Enroll</label>
                    <select id="studentSelect" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #e0e0e0;">
                        <option value="">-- Select Student --</option>
                    </select>
                    <button class="btn btn-success" style="margin-top: 10px;" onclick="enrollStudent()">Enroll Student</button>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Enrolled Students</h3>
                <div id="enrolledStudents" class="student-list"></div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let authToken = null;
        let currentCourseForEnrollment = null;

        // API base URL
        const API_BASE = '/api';

        // Show message
        function showMessage(message, type = 'success') {
            const msgEl = $('#globalMessage');
            msgEl.text(message)
               .removeClass('success error')
               .addClass(type)
               .fadeIn();

            setTimeout(() => msgEl.fadeOut(), 5000);
        }

        // API request helper
        async function apiRequest(endpoint, options = {}) {
            try {
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };

                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                const response = await fetch(`${API_BASE}${endpoint}`, {
                    ...options,
                    headers
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Request failed');
                }

                return data;
            } catch (error) {
                console.error('API Error:', error);
                showMessage(error.message, 'error');
                throw error;
            }
        }

        // Auth tab switching
        function showAuthTab(tab) {
            $('.tab').removeClass('active');
            $(`button:contains("${tab === 'student' ? 'Student Portal' : 'Admin Portal'}")`).addClass('active');

            if (tab === 'student') {
                $('#studentAuthTab').removeClass('hidden');
                $('#adminAuthTab').addClass('hidden');
            } else {
                $('#studentAuthTab').addClass('hidden');
                $('#adminAuthTab').removeClass('hidden');
            }
        }

        // Admin tab switching
        function showAdminTab(tab) {
            $('.tabs .tab').removeClass('active');
            $(`button:contains("${tab === 'courses' ? 'Manage Courses' : 'Manage Students'}")`).addClass('active');

            if (tab === 'courses') {
                $('#adminCoursesTab').removeClass('hidden');
                $('#adminStudentsTab').addClass('hidden');
                loadAdminCourses();
            } else {
                $('#adminCoursesTab').addClass('hidden');
                $('#adminStudentsTab').removeClass('hidden');
                loadStudents();
            }
        }

        // Student Signup
        $('#studentSignupForm').on('submit', async function(e) {
            e.preventDefault();

            const data = {
                name: $('#studentSignupName').val(),
                email: $('#studentSignupEmail').val(),
                password: $('#studentSignupPassword').val()
            };

            try {
                const result = await apiRequest('/students/signup', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                authToken = result.token;
                currentUser = { ...result.student, type: 'student' };
                showMessage('Welcome! Your account has been created.', 'success');
                showDashboard();
            } catch (error) {
                // Error already shown in apiRequest
            }
        });

        // Student Login
        $('#studentLoginForm').on('submit', async function(e) {
            e.preventDefault();

            const data = {
                email: $('#studentLoginEmail').val(),
                password: $('#studentLoginPassword').val()
            };

            try {
                const result = await apiRequest('/students/login', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                authToken = result.token;
                currentUser = { ...result.student, type: 'student' };
                showMessage('Welcome back!', 'success');
                showDashboard();
            } catch (error) {
                // Error already shown in apiRequest
            }
        });

        // Admin Login
        $('#adminLoginForm').on('submit', async function(e) {
            e.preventDefault();

            const data = {
                username: $('#adminLoginUsername').val(),
                password: $('#adminLoginPassword').val()
            };

            try {
                const result = await apiRequest('/admin/login', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                authToken = result.token;
                currentUser = { ...result.admin, type: 'admin' };
                showMessage('Admin access granted', 'success');
                showDashboard();
            } catch (error) {
                // Error already shown in apiRequest
            }
        });

        // Show appropriate dashboard
        function showDashboard() {
            $('#authSection').addClass('hidden');
            $('#userInfo').removeClass('hidden');

            if (currentUser.type === 'student') {
                $('#userDisplay').text(currentUser.email);
                $('#userRole').text('(Student)');
                $('#studentDashboard').removeClass('hidden').addClass('fade-in');
                $('#adminDashboard').addClass('hidden');
                loadStudentCourses();
            } else {
                $('#userDisplay').text(currentUser.username);
                $('#userRole').text('(Administrator)');
                $('#adminDashboard').removeClass('hidden').addClass('fade-in');
                $('#studentDashboard').addClass('hidden');
                loadAdminCourses();
            }
        }

        // Logout
        function logout() {
            currentUser = null;
            authToken = null;
            $('#authSection').removeClass('hidden');
            $('#userInfo').addClass('hidden');
            $('#studentDashboard').addClass('hidden');
            $('#adminDashboard').addClass('hidden');

            // Clear forms
            $('form').trigger('reset');
            showMessage('Logged out successfully', 'success');
        }

        // Load student courses
        async function loadStudentCourses() {
            try {
                const result = await apiRequest(`/students/${currentUser.id}/courses`);
                const container = $('#studentCourses');
                container.empty();

                if (result.courses.length === 0) {
                    container.html('<p style="text-align: center; color: #999; padding: 40px;">No courses enrolled yet. Contact admin to get enrolled.</p>');
                    return;
                }

                result.courses.forEach(course => {
                    const card = $(`
                        <div class="course-card">
                            <div class="course-title">${course.title}</div>
                            <div class="course-description">${course.description}</div>
                            <div style="color: #999; font-size: 0.9em; margin-top: 10px;">
                                Enrolled: ${new Date(course.enrolled_at).toLocaleDateString()}
                            </div>
                        </div>
                    `);
                    container.append(card);
                });
            } catch (error) {
                // Error already shown
            }
        }

        // Load admin courses
        async function loadAdminCourses() {
            try {
                const result = await apiRequest('/courses');
                const container = $('#adminCourses');
                container.empty();

                if (result.courses.length === 0) {
                    container.html('<p style="text-align: center; color: #999; padding: 40px;">No courses created yet. Click "Create New Course" to begin.</p>');
                    return;
                }

                result.courses.forEach(course => {
                    const card = $(`
                        <div class="course-card">
                            <div class="course-title">${course.title}</div>
                            <div class="course-description">${course.description}</div>
                            <div class="course-actions">
                                <button class="btn btn-primary" onclick="editCourse(${course.id}, '${course.title.replace(/'/g, "\\'")}', '${course.description.replace(/'/g, "\\'")}')">Edit</button>
                                <button class="btn btn-secondary" onclick="manageCourseEnrollments(${course.id}, '${course.title.replace(/'/g, "\\'")}')">Enrollments</button>
                                <button class="btn btn-danger" onclick="deleteCourse(${course.id})">Delete</button>
                            </div>
                        </div>
                    `);
                    container.append(card);
                });
            } catch (error) {
                // Error already shown
            }
        }

        // Course modal
        function showCourseModal() {
            $('#courseModalTitle').text('Create Course');
            $('#courseForm').trigger('reset');
            $('#courseId').val('');
            $('#courseModal').fadeIn();
        }

        function closeCourseModal() {
            $('#courseModal').fadeOut();
        }

        function editCourse(id, title, description) {
            $('#courseModalTitle').text('Edit Course');
            $('#courseId').val(id);
            $('#courseTitle').val(title);
            $('#courseDescription').val(description);
            $('#courseModal').fadeIn();
        }

        // Course form submit
        $('#courseForm').on('submit', async function(e) {
            e.preventDefault();

            const courseId = $('#courseId').val();
            const data = {
                title: $('#courseTitle').val(),
                description: $('#courseDescription').val()
            };

            try {
                if (courseId) {
                    await apiRequest(`/courses/${courseId}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                    showMessage('Course updated successfully', 'success');
                } else {
                    await apiRequest('/courses', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    showMessage('Course created successfully', 'success');
                }

                closeCourseModal();
                loadAdminCourses();
            } catch (error) {
                // Error already shown
            }
        });

        // Delete course
        async function deleteCourse(id) {
            if (!confirm('Are you sure you want to delete this course?')) {
                return;
            }

            try {
                await apiRequest(`/courses/${id}`, { method: 'DELETE' });
                showMessage('Course deleted successfully', 'success');
                loadAdminCourses();
            } catch (error) {
                // Error already shown
            }
        }

        // Load students
        async function loadStudents() {
            try {
                const result = await apiRequest('/students');
                const container = $('#adminStudents');
                container.empty();

                if (result.students.length === 0) {
                    container.html('<p style="text-align: center; color: #999; padding: 40px;">No students registered yet.</p>');
                    return;
                }

                result.students.forEach(student => {
                    const item = $(`
                        <div class="student-item">
                            <div>
                                <strong>${student.name || 'N/A'}</strong><br>
                                <span style="color: #666;">${student.email}</span><br>
                                <small style="color: #999;">Joined: ${new Date(student.created_at).toLocaleDateString()}</small>
                            </div>
                        </div>
                    `);
                    container.append(item);
                });
            } catch (error) {
                // Error already shown
            }
        }

        // Enrollment management
        async function manageCourseEnrollments(courseId, courseTitle) {
            currentCourseForEnrollment = courseId;
            $('#enrollmentCourseTitle').text(courseTitle);

            // Load all students for selection
            try {
                const studentsResult = await apiRequest('/students');
                const select = $('#studentSelect');
                select.empty().append('<option value="">-- Select Student --</option>');

                studentsResult.students.forEach(student => {
                    select.append(`<option value="${student.id}">${student.email} - ${student.name || 'N/A'}</option>`);
                });

                // Load enrolled students
                await loadEnrolledStudents(courseId);

                $('#enrollmentModal').fadeIn();
            } catch (error) {
                // Error already shown
            }
        }

        function closeEnrollmentModal() {
            $('#enrollmentModal').fadeOut();
            currentCourseForEnrollment = null;
        }

        async function loadEnrolledStudents(courseId) {
            try {
                const result = await apiRequest(`/courses/${courseId}/students`);
                const container = $('#enrolledStudents');
                container.empty();

                if (result.students.length === 0) {
                    container.html('<p style="text-align: center; color: #999; padding: 20px;">No students enrolled yet.</p>');
                    return;
                }

                result.students.forEach(student => {
                    const item = $(`
                        <div class="enrollment-item">
                            <div>
                                <strong>${student.name || 'N/A'}</strong><br>
                                <span style="color: #666;">${student.email}</span>
                            </div>
                            <button class="btn btn-danger" onclick="unenrollStudent(${student.id}, ${courseId})">Remove</button>
                        </div>
                    `);
                    container.append(item);
                });
            } catch (error) {
                // Error already shown
            }
        }

        async function enrollStudent() {
            const studentId = $('#studentSelect').val();

            if (!studentId) {
                showMessage('Please select a student', 'error');
                return;
            }

            try {
                await apiRequest('/enrollments', {
                    method: 'POST',
                    body: JSON.stringify({
                        student_id: parseInt(studentId),
                        course_id: currentCourseForEnrollment
                    })
                });

                showMessage('Student enrolled successfully', 'success');
                $('#studentSelect').val('');
                await loadEnrolledStudents(currentCourseForEnrollment);
            } catch (error) {
                // Error already shown
            }
        }

        async function unenrollStudent(studentId, courseId) {
            if (!confirm('Are you sure you want to remove this student from the course?')) {
                return;
            }

            try {
                await apiRequest(`/enrollments/${studentId}/${courseId}`, {
                    method: 'DELETE'
                });

                showMessage('Student removed from course', 'success');
                await loadEnrolledStudents(courseId);
            } catch (error) {
                // Error already shown
            }
        }

        // Check health on load
        $(document).ready(async function() {
            try {
                const health = await fetch('/api/health').then(r => r.json());
                console.log('App Health:', health);
            } catch (error) {
                console.error('Health check failed:', error);
            }
        });
    </script>
</body>
</html>
